name: Vintelligent Africa Hybrid Engine

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # STEP 1: SETUP R
      - name: Setup R
        uses: r-lib/actions/setup-r@v2
      
      - name: Install R Dependencies
        run: |
          Rscript -e 'install.packages(c("rvest", "jsonlite"))'

      # STEP 2: SETUP PYTHON
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python Tooling
        run: |
          pip uninstall google google-generativeai -y
          pip install requests feedparser google-genai

      # STEP 3: RUN HYBRID PIPELINE
      - name: Run R Scraper
        run: Rscript analysis.R

      - name: Run Python AI Engine
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: python veille.py

      # STEP 4: PUBLISH
      - name: Publish Official Data
        run: |
          git config --global user.name "Vintelligent-Bot"
          git config --global user.email "bot@vintelligent.africa"
          git add data.json
          git commit -m "HYBRID SYNC: $(date +'%d-%m-%Y')" || exit 0
          git push
